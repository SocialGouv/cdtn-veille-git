include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops_simple_app.yml
    ref: v15.1.0

variables:
  PROJECT: "cdtn-veille-git"
  PORT: 3000
  VALUES_FILE: ./.k8s/app.values.yml # Your values
  GIT_SUBMODULE_STRATEGY: none

#


Create namespace:
  only:
    - never
  script:
    - exit ${CI_JOB_SKIP_EXIT_CODE:-0}

#

.deploy_app_stage:
  stage: Deploy
  image: registry.gitlab.factory.social.gouv.fr/socialgouv/docker/kosko:1.13.0
  variables:
    IMAGE_TAG: $CI_COMMIT_SHA

Deploy app (dev):
  extends:
    - .autodevops_deploy_app_dev
    - .deploy_app_stage
  cache:
    key:
      files:
        - .k8s/yarn.lock
    paths:
      - .k8s/node_modules
  script:
    - yarn --cwd .k8s --frozen-lockfile
    - yarn --silent --cwd .k8s
      kosko generate --env gitlab
    - yarn --silent --cwd .k8s
      kosko generate --env gitlab | kubectl apply -f -

Deploy app (prod):
  extends:
    - .autodevops_deploy_app_prod
    - .deploy_app_stage
  script:
    - cd .k8s
    - kosko generate --env prod | kubectl apply -f -
